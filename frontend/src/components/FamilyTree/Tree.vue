<template>
  <main class="flex h-main">
    <aside class="hidden sm:block">
      <side-bar></side-bar>
    </aside>
    <transition name="sidebar">
      <aside
          v-if="mobileSideBar"
          v-click-outside="closeMobileSideBar"
          class="sm:hidden block absolute bg-white h-main z-10"
      >
        <side-bar></side-bar>
      </aside>
    </transition>
    <div class="h-full w-full">
      <router-view></router-view>
      <v-network-graph
          class="!static"
          :nodes="nodes"
          :edges="edges"
          :layouts="layouts"
          :configs="configs"
          :event-handlers="eventHandlers"
      >
        <defs>
          <clipPath id="faceCircle" clipPathUnits="objectBoundingBox">
            <circle cx="0.5" cy="0.5" r="0.5"/>
          </clipPath>
        </defs>
        <template #override-node="{ nodeId, scale, config, ...slotProps }">
          <image
              class="face-picture"
              :x="-config.radius * scale"
              :y="-config.radius * scale"
              :width="config.radius * scale * 2"
              :height="config.radius * scale * 2"
              :xlink:href="`http://127.0.0.1:3000/src/assets/${nodes[nodeId].face}`"
              clip-path="url(#faceCircle)"
          />
          <circle
              class="face-circle"
              :r="config.radius * scale"
              fill="none"
              :stroke-width="1 * scale"
              v-bind="slotProps"
          />
        </template>
      </v-network-graph>
      <context-menu v-model="ctxMenuShow" :conf="ctxMenuConf">
        <component :is="ctxMenuComponent"></component>
      </context-menu>
    </div>
  </main>
</template>

<script setup>
import SideBar from "../../components/UI/SideBar.vue";
import ContextMenu from "../UI/Context/ContextMenu.vue";
import NodeCtxMenu from "./CtxMenu/NodeCtxMenu.vue";
import EdgeCtxMenu from "./CtxMenu/EdgeCtxMenu.vue";
import ViewCtxMenu from "./CtxMenu/ViewCtxMenu.vue";
import * as vNG from "v-network-graph";
import {reactive, ref, shallowRef, computed, nextTick} from "vue";
import {useStore} from "vuex";

const store = useStore()

const ctxMenuShow = ref(false)
const ctxMenuComponent = shallowRef(ViewCtxMenu)
const ctxMenuConf = reactive({x: 0, y: 0})

function showCtxMenu(component) {
  function setPositionCtxMenu({event}) {
    event.stopPropagation()
    event.preventDefault()
    ctxMenuShow.value = true
    ctxMenuComponent.value = component
    nextTick(() => {
      ctxMenuConf.x = event.x
      ctxMenuConf.y = event.y
    })
    const handler = (event) => {
      if (!event.target) {
        ctxMenuShow.value = false
        document.removeEventListener("pointerdown", handler, {capture: true})
      }
    }
    document.addEventListener("pointerdown", handler, {passive: true, capture: true})
  }
  return setPositionCtxMenu
}

const mobileSideBar = computed(() => store.getters.mobileSideBar)

function closeMobileSideBar() {
  store.dispatch('setMobileSideBar', false)
}

const eventHandlers = {
  "view:contextmenu": showCtxMenu(ViewCtxMenu),
  "node:contextmenu": showCtxMenu(NodeCtxMenu),
  "edge:contextmenu": showCtxMenu(EdgeCtxMenu),
}
const nodes = {
  node1: {name: "Dionysios Tijs Ruya", face: "1.jpg"},
  node2: {name: "Roeland Caradoc Hafza", face: "2.jpg"},
  node3: {name: "Ginnie Kalyana Hadewig", face: "3.jpg"},
  node4: {name: "Toros Sigilind Davonte", face: "4.jpg"},
}
const edges = {
  edge1: {source: "node1", target: "node2"},
  edge2: {source: "node2", target: "node3"},
  edge3: {source: "node3", target: "node4"},
}
const layouts = {
  nodes: {
    node1: {x: 0, y: 0},
    node2: {x: 200, y: 200},
    node3: {x: 400, y: 0},
    node4: {x: 600, y: 200},
  }
}
const configs = reactive(
    vNG.defineConfigs({
      view: {
        scalingObjects: true,
        minZoomLevel: 0.1,
        maxZoomLevel: 16,
        autoPanAndZoomOnLoad: 'fit-content'
      },
    })
)
</script>

<style scoped>
.sidebar-enter-active,
.sidebar-leave-active {
  transition: all 0.5s ease;
}

.sidebar-enter-from,
.sidebar-leave-to {
  opacity: 0;
  transform: translateX(-35px);
}

.face-circle,
.face-picture {
  transition: all 0.1s linear;
}

.face-picture {
  pointer-events: none;
  border-radius: 50%;
}
</style>